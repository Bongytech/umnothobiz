name: Weekly Secrets Audit
on:
  schedule:
    - cron: '0 2 * * 0'  # 2 AM every Sunday
  workflow_dispatch:

jobs:
  deep-audit:
    name: Deep Historical Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get entire git history
          
      - name: Run TruffleHog on Entire History
        run: |
          docker run --rm -v "$(pwd):/pwd" trufflesecurity/trufflehog:latest \
            git file:///pwd \
            --only-verified \
            --json \
            --fail \
            | tee trufflehog-full-history-$(date +%Y%m%d).json
          
      - name: Check for Firebase-specific secrets
        run: |
          # Custom scan for Firebase patterns
          echo "=== Scanning for Firebase patterns ==="
          grep -r "AIza[0-9A-Za-z\\-_]\{35\}" . --include="*.ts" --include="*.js" --include="*.json" || true
          echo "=== Scanning for service accounts ==="
          grep -r '"type": "service_account"' . --include="*.json" --include="*.ts" --include="*.js" || true
          
      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-audit-${{ github.sha }}
          path: |
            trufflehog-full-history-*.json
            gitleaks-report.sarif
          
      - name: Send Weekly Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Weekly Secrets Audit - ${{ github.repository }}"
          to: security-team@umnotho.com
          from: GitHub Actions <actions@umnotho.com>
          body: |
            Weekly secrets audit completed for ${{ github.repository }}.
            
            Run ID: ${{ github.run_id }}
            Date: $(date)
            
            View detailed report in GitHub Actions.