name: Secrets Detection
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Manual trigger

jobs:
  secrets-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trufflehog
          
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        id: gitleaks
        with:
          config-path: .gitleaks.toml
          no-git: false
          verbose: true
          redact: true
          severity: high
          
      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        id: trufflehog
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head: HEAD
          extra_args: |
            --only-verified 
            --json 
            --fail
          
      - name: Upload SARIF Report
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gitleaks-report.sarif
          
      - name: Send Slack Alert on Failure
        if: failure() && github.event_name == 'push'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'security-alerts'
          slack-message: |
            ðŸš¨ SECRETS DETECTED in ${{ github.repository }}!
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}
            Scan Results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}